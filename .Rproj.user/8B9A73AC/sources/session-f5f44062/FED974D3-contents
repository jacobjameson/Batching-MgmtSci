

data <- final


mod1 <- felm(
  batched ~ CHIEF_COMPLAINT + as.factor(ESI) + tachycardic + tachypneic + febrile + hypotensive + 
    ARRIVAL_AGE_DI + capacity_level + GENDER + race + EXPERIENCE + PROVIDER_SEX|  dayofweekt + month_of_year| 0|ED_PROVIDER, data = data)

# get coefficients and 95% CI
p1 <- data.frame(
  var = names(coef(mod1)),
  coef = coef(mod1),
  conf.low = confint(mod1)[,1],
  conf.high = confint(mod1)[,2],
  model = "Batched"
)

mod2 <- felm(
  batch.tendency ~  CHIEF_COMPLAINT + as.factor(ESI) + tachycardic + tachypneic + febrile + hypotensive + 
    ARRIVAL_AGE_DI + capacity_level + GENDER + race + EXPERIENCE + PROVIDER_SEX|  dayofweekt + month_of_year| 0|ED_PROVIDER, data = data)

p2 <- data.frame(
  var = names(coef(mod2)),
  coef = coef(mod2),
  conf.low = confint(mod2)[,1],
  conf.high = confint(mod2)[,2],
  model = "Physician Batch Tendency"
)

panels <- rbind(p1, p2)

# create a variable called category that is either patient characteristic, physician characteristic, or other
panels$category <- dplyr::recode(panels$var,
                                 "CHIEF_COMPLAINTAbnormal Test Results" = "Patient characteristic",
                                 "CHIEF_COMPLAINTBack or Flank Pain" = "Patient characteristic",
                                 "CHIEF_COMPLAINTCardiac Arrhythmias" = "Patient characteristic",
                                 "CHIEF_COMPLAINTChest Pain" = "Patient characteristic",
                                 "CHIEF_COMPLAINTDizziness/Lightheadedness/Syncope" = "Patient characteristic",
                                 "CHIEF_COMPLAINTExtremity Complaints" = "Patient characteristic",
                                 "CHIEF_COMPLAINTFalls, MVA, Assaults, and Trauma" = "Patient characteristic",
                                 "CHIEF_COMPLAINTFatigue and Weakness" = "Patient characteristic",
                                 "CHIEF_COMPLAINTFevers, Sweats or Chills" = "Patient characteristic",
                                 "CHIEF_COMPLAINTGastrointestinal Issues" = "Patient characteristic",
                                 "CHIEF_COMPLAINTNeurological Issue" = "Patient characteristic",
                                 "CHIEF_COMPLAINTShortness of Breath" = "Patient characteristic",
                                 "CHIEF_COMPLAINTSkin Complaints" = "Patient characteristic",
                                 "CHIEF_COMPLAINTUpper Respiratory Symptoms" = "Patient characteristic",
                                 "CHIEF_COMPLAINTUrinary Complaints" = "Patient characteristic",
                                 
                                 # ESI Levels
                                 "as.factor(ESI)2" = "Patient characteristic",
                                 "as.factor(ESI)3" = "Patient characteristic",
                                 "as.factor(ESI)4" = "Patient characteristic",
                                 "as.factor(ESI)5" = "Patient characteristic",
                                 
                                 # Vitals
                                 "tachycardic" = "Patient characteristic",
                                 "tachypneic" = "Patient characteristic",
                                 "febrile" = "Patient characteristic",
                                 "hypotensive" = "Patient characteristic",
                                 
                                 # Age Variable
                                 "ARRIVAL_AGE_DI" = "Patient characteristic",
                                 
                                 # Capacity Level
                                 "capacity_levelMinor Overcapacity" = "ED characteristic",
                                 "capacity_levelNormal Operations" = "ED characteristic",
                                 
                                 # Gender
                                 "GENDERMale" = "Patient characteristic",
                                 
                                 # Race Variables
                                 "raceblack" = "Patient characteristic",
                                 "racenative" = "Patient characteristic",
                                 "raceother" = "Patient characteristic",
                                 "raceunknown" = "Patient characteristic",
                                 "racewhite" = "Patient characteristic",
                                 
                                 'PROVIDER_SEXM' = 'Physician characteristic',
                                 'EXPERIENCE' = 'Physician characteristic',
                                 )

panels$var <- dplyr::recode(panels$var,
                            # Chief Complaint Variables
                            "CHIEF_COMPLAINTAbnormal Test Results" = "Abnormal Test Results",
                            "CHIEF_COMPLAINTBack or Flank Pain" = "Back or Flank Pain",
                            "CHIEF_COMPLAINTCardiac Arrhythmias" = "Cardiac Arrhythmias",
                            "CHIEF_COMPLAINTChest Pain" = "Chest Pain",
                            "CHIEF_COMPLAINTDizziness/Lightheadedness/Syncope" = "Dizziness/Lightheadedness",
                            "CHIEF_COMPLAINTExtremity Complaints" = "Extremity Complaints",
                            "CHIEF_COMPLAINTFalls, MVA, Assaults, and Trauma" = "Falls/Crashes/Assaults/Trauma",
                            "CHIEF_COMPLAINTFatigue and Weakness" = "Fatigue and Weakness",
                            "CHIEF_COMPLAINTFevers, Sweats or Chills" = "Fevers/Sweats/Chills",
                            "CHIEF_COMPLAINTGastrointestinal Issues" = "Gastrointestinal Issues",
                            "CHIEF_COMPLAINTNeurological Issue" = "Neurological Issue",
                            "CHIEF_COMPLAINTShortness of Breath" = "Shortness of Breath",
                            "CHIEF_COMPLAINTSkin Complaints" = "Skin Complaints",
                            "CHIEF_COMPLAINTUpper Respiratory Symptoms" = "Upper Respiratory Symptoms",
                            "CHIEF_COMPLAINTUrinary Complaints" = "Urinary Complaints",
                            
                            # ESI Levels
                            "as.factor(ESI)2" = "ESI Level 2",
                            "as.factor(ESI)3" = "ESI Level 3",
                            "as.factor(ESI)4" = "ESI Level 4",
                            "as.factor(ESI)5" = "ESI Level 5",
                            
                            # Vitals
                            "tachycardic" = "Tachycardic",
                            "tachypneic" = "Tachypneic",
                            "febrile" = "Febrile",
                            "hypotensive" = "Hypotensive",
                            
                            # Age Variable
                            "ARRIVAL_AGE_DI" = "Arrival Age",
                            
                            # Capacity Level
                            "capacity_levelMinor Overcapacity" = "ED Capacity: Minor Overcapacity",
                            "capacity_levelNormal Operations" = "ED Capacity: Normal Operations",
                            
                            # Gender
                            "GENDERMale" = "Sex: Male",
                            
                            # Race Variables
                            "raceblack" = "Race: Black",
                            "racenative" = "Race: Native",
                            "raceother" = "Race: Other",
                            "raceunknown" = "Race: Unknown",
                            "racewhite" = "Race: White",
                            
                            'PROVIDER_SEXM' = 'Physician Male',
                            'EXPERIENCE' = 'Physician Experience',
)

library(ggsci)

ggplot(panels, aes(x = reorder(var, coef), y = coef,
                   ymin = conf.low, ymax = conf.high, 
                   color=category)) +
  geom_pointrange(size = 0.5) +  
  geom_hline(yintercept = 0, linetype = "solid",
             color = "black") +
  facet_wrap(~model) +
  scale_color_nejm() +
  coord_flip() +
  theme_minimal(base_size = 14) +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10, color = "black"),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    axis.title.y = element_blank(),
    # add an outline around the plot
    panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
    strip.background = element_rect(fill = "white"),
    strip.text = element_text(size = 14, face = "bold"),
    legend.position = "top"
  ) +
  labs(title = NULL,
       x = "",
       color = '',
       y = "Coefficient")

ggsave("panel_batched.png", width = 10, height = 8, units = "in", bg = "white")







max_density <- max(density(data$batch.tendency)$y)

plot <- ggplot(data, aes(x = batch.tendency)) +
  geom_histogram(aes(y = after_stat(density)), 
                 fill = "#2972b6", color = "black", 
                 bins = 10, alpha = 0.7) +
  geom_smooth(aes(y = batched * max(density(batch.tendency)$y) * (100/30)), 
              method = "loess", span = 0.6,
              linetype = "solid", size = 1, color = "#d8031c", fill ='#d8031c') +
  labs(
    x = "Batch Tendency"
  ) +
  scale_y_continuous(
    name = "Percentage of Sample",
    labels = scales::percent_format(scale = 1),
    sec.axis = sec_axis(~./max(density(data$batch.tendency)$y) * (30/100), 
                        name = "Probability of Batching",
                        breaks = seq(0, .5, .1),
                        labels = scales::percent_format(scale = 100))
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.title.y.right = element_text(color = "black"),
    axis.text.y.right = element_text(color = "black")
  )




ggsave("firststage.png", width = 8, height = 6, units = "in", bg = "white")


